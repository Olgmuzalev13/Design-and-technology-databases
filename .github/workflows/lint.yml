name: Lint

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install .
    
    - name: Run flake8
      run: |
        flake8 project8sem/ \
          --max-line-length=100 \
          --extend-ignore=E203,W503 \
          --max-complexity=10 \
          --exclude=.git,__pycache__,.venv,venv,env,migrations,static,media,build,my_django_project.egg-info \
          --per-file-ignores=__init__.py:F401,tests/*:S101,*/migrations/*:E501 \
          --count \
          --statistics

  tests:
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        - name: Export UID/GID for docker
          run: |
            echo "UID=$(id -u)" >> $GITHUB_ENV
            echo "GID=$(id -g)" >> $GITHUB_ENV

        - name: Build and run containers
          run: docker compose up --build -d

        - name: Wait for db
          run: sleep 5

        - name: Run tests with coverage
          run: |
            docker compose exec -T web coverage run manage.py test
            docker compose exec -T web coverage report --fail-under=75
            docker compose exec -T web coverage json -o coverage.json

        - name: Stop containers
          if: always()
          run: docker compose down
          
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'
            cache: pip

        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install .

        - name: Run tests only coverage
          run: |
            coverage run project8sem/manage.py test
            coverage report --fail-under=75
            coverage json -o coverage.json

        - name: Update coverage badge
          if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
          uses: we-cli/coverage-badge-action@main